{% extends 'bases/_base.html' %}
{% load static %}
{% block title %}Upload Proofs{% endblock title %}
{% block head_js %}
	<script src="{% static 'static/js/webcam-easy.min.js' %}"></script>
	{#<style>#}
	{#  body {#}
	{#    background-color: black;#}
	{#  }#}
	{##}
	{#  .btn-back {#}
	{#    position: fixed;#}
	{#    top: 30px;#}
	{#    left: 30px;#}
	{#  }#}
	{##}
	{#  .buttons {#}
	{#    position: fixed;#}
	{#    bottom: 20px;#}
	{#    left: 0;#}
	{#    right: 0;#}
	{#    text-align: center;#}
	{#  }#}
	{##}
	{#  #take-photo-step {#}
	{#    height: 100%;#}
	{#    display: flex;#}
	{#    align-items: center;#}
	{#  }#}
	{##}
	{#  video {#}
	{#    width: 100%;#}
	{#    height: auto;#}
	{#  }#}
	{##}
	{#  #upload-step {#}
	{#    height: 100%;#}
	{#    display: none;#}
	{#    align-items: center;#}
	{#  }#}
	{#</style>#}

{% endblock %}

{% block content %}
	<div id="upload-step" class="h-auto mb-4 mt-4">
		<img id="photo" class="rounded-lg mb-4 mt-4"  alt="">
		<div class="flex justify-center">
			<a id="retake-button" class="text-center inline-flex items-center me-2 bg-primary-700 hover:bg-primary-800 text-white font-bold py-2 px-4 rounded-lg" href="javascript:void(retake_photo())">Retake</a>
			<a id="upload-button" class="text-center inline-flex items-center me-2 bg-primary-900 hover:bg-primary-800 text-white font-bold py-2 px-4 rounded-lg" href="javascript:void(upload_photo())">
				Upload {% if delivery_task.status == 'pickup_in_progress' %}Pickup{% else %}Drop-off{% endif %}
				Photo
			</a>
		</div>
	</div>

	<div id="take-photo-step" class="mb-4">
		<video id="webcam" class="rounded-lg h-auto w-auto mt-8 mx-auto" autoplay playsinline></video>
		<canvas id="canvas" class="mb-4 mt-4 rounded-lg d-none sm:mb-4 md:mb-4 sm:mt-4 md:mt-4"></canvas>
		<div class="flex justify-center">
			<a href="{% url 'couriers:delivery_task' %}"
			   class="text-center inline-flex items-center me-2 bg-primary-900 hover:bg-primary-800 text-white font-bold py-2 px-4 rounded-lg">
				<svg class="w-6 h-6 text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
				     width="24" height="24" fill="none" viewBox="0 0 24 24">
					<path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
					      d="m15 19-7-7 7-7"></path>
				</svg>
				Back
			</a>


			<a href="javascript:void(take_photo())"
			   class=" text-center inline-flex items-center me-2 bg-primary-700 hover:bg-primary-800 text-white font-bold py-2 px-4 rounded-lg">
				Take {% if delivery_task.status == 'pickup_in_progress' %}Pickup{% else %}Drop-off{% endif %} Photo
			</a>
		</div>
	</div>

	<script>
        const webcamElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('canvas');
        const webcam = new Webcam(webcamElement, 'environment', canvasElement);
        webcam.start();

        function take_photo() {
            let picture = webcam.snap();
            console.log(picture);

            $("#photo").attr("src", picture);
            $("#take-photo-step").css("display", "none");
            $("#upload-step").css("display", "flex");
        }

        function retake_photo() {
            $("#upload-step").css("display", "none");
            $("#take-photo-step").css("display", "flex");
        }

        function upload_photo() {
            document.getElementById("canvas").toBlob(function (blob) {
                var formData = new FormData();
                var upload_name = "{% if delivery_task.status == 'pickup_in_progress' %}pickup{% else %}delivery{% endif %}_photo"
                formData.append(upload_name, blob, upload_name + '.png');

                fetch("{% url 'couriers:courier_delivery_tasks_status' delivery_task.pk %}", {
                    method: "POST",
                    body: formData
                })
                    .then(function (response) {
                        return response.json()
                    })
                    .then(function (json) {
                        if (json.success) {
                            window.location.href = "{% if delivery_task.status == 'pickup_in_progress' %}{% url 'couriers:delivery_task' %}{% else %}{% url 'couriers:delivery_task_completed' %}{% endif%}"
                        }
                    })
            })
        }

	</script>

{% endblock %}